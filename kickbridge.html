<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kick & Streamer.bot Bridge</title>
    <script src="https://js.pusher.com/8.3.0/pusher.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #888;
            font-size: 1.1rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            padding: 20px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-connected .status-dot {
            background: #4aff4a;
            box-shadow: 0 0 10px rgba(74, 255, 74, 0.5);
        }
        
        .status-disconnected .status-dot {
            background: #ff4a4a;
            box-shadow: 0 0 10px rgba(255, 74, 74, 0.5);
        }
        
        .status-connecting .status-dot {
            background: #ffaa4a;
            box-shadow: 0 0 10px rgba(255, 170, 74, 0.5);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .logs-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .logs-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logs-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
        }
        
        .logs-controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .btn-clear {
            background: #ff4757;
            color: white;
        }
        
        .btn-clear:hover {
            background: #ff3742;
        }
        
        .btn-pause {
            background: #ffa502;
            color: white;
        }
        
        .btn-pause:hover {
            background: #ff9500;
        }
        
        #messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: #444 #222;
        }
        
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        
        #messages::-webkit-scrollbar-track {
            background: #222;
        }
        
        #messages::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        #messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid transparent;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.2s ease;
        }
        
        .log-entry:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .log-info {
            color: #74b9ff;
            border-left-color: #74b9ff;
        }
        
        .log-success {
            color: #00b894;
            border-left-color: #00b894;
            background: rgba(0, 184, 148, 0.1);
        }
        
        .log-error {
            color: #e17055;
            border-left-color: #e17055;
            background: rgba(225, 112, 85, 0.1);
        }
        
        .log-warning {
            color: #fdcb6e;
            border-left-color: #fdcb6e;
            background: rgba(253, 203, 110, 0.1);
        }
        
        .log-reward {
            color: #fd79a8;
            border-left-color: #fd79a8;
            background: rgba(253, 121, 168, 0.1);
            font-weight: 600;
        }
        
        .log-chat {
            color: #81ecec;
            border-left-color: #81ecec;
        }
        
        .log-connection {
            color: #a29bfe;
            border-left-color: #a29bfe;
        }
        
        .log-timestamp {
            color: #636e72;
            font-size: 11px;
            margin-right: 8px;
        }
        
        .log-category {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 8px;
            text-transform: uppercase;
        }
        
        .category-kick {
            background: #ff6b6b;
            color: white;
        }
        
        .category-sb {
            background: #4ecdc4;
            color: white;
        }
        
        .category-system {
            background: #45b7d1;
            color: white;
        }
        
        .category-kick::before {
            content: "";
            background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15V7h2v4l4-4h3l-4 4 4 4h-3l-4-4v4h-2z" fill="%23ffffff"/></svg>');
            background-size: 14px 14px;
            background-repeat: no-repeat;
            background-position: center;
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 6px;
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.8));
            border-radius: 2px;
            background-color: rgba(255,255,255,0.1);
        }
        
        .category-sb::before {
            content: "";
            background-image: url('https://streamer.bot/logo.svg');
            background-size: 14px 14px;
            background-repeat: no-repeat;
            background-position: center;
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 6px;
            filter: brightness(0) invert(1) drop-shadow(0 0 2px rgba(255,255,255,0.8));
            border-radius: 2px;
            background-color: rgba(255,255,255,0.1);
        }
        
        .category-system::before {
            content: "⚙️";
            margin-right: 4px;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; padding: 0; margin: 0; }
        .hidden { display: none !important; }
        .center-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0; left: 0;
            z-index: 9999;
            background: rgba(15,15,15,0.97);
        }
        .error-box {
            background: #ff3b3b;
            color: #fff;
            padding: 2em 2.5em;
            border-radius: 14px;
            font-size: 1.3em;
            font-weight: bold;
            box-shadow: 0 4px 32px rgba(0,0,0,0.25);
            text-align: center;
            border: 2px solid #fff;
        }
    </style>
</head>
<body style="background: transparent;">
    <div id="status-message" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;z-index:9999;background:rgba(15,15,15,0.85);color:#fff;font-size:2em;font-weight:bold;text-align:center;"></div>
<script>
    function showStatus(msg) {
        var el = document.getElementById('status-message');
        el.textContent = msg;
        el.style.display = 'flex';
    }
    function hideStatus() {
        var el = document.getElementById('status-message');
        el.style.display = 'none';
    }
    function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }
    function getSetting(name) {
        const qp = getQueryParam(name);
        if (qp) return qp;
        const settings = JSON.parse(localStorage.getItem('kickBridgeSettings') || '{}');
        if (name === 'chatroom_id') return settings.chatroomId;
        if (name === 'sb_ip') return settings.sbIp;
        if (name === 'sb_port') return settings.sbPort;
        return undefined;
    }
    // Use 'chatroomid' as the main query parameter for the chatroom ID
    const chatroomId = getQueryParam('chatroomid');
    // Use defaults if sbip or sbport are missing
    const sbIp = getQueryParam('sbip') || '127.0.0.1';
    const sbPort = getQueryParam('sbport') || '8080';
    if (!chatroomId || !sbIp || !sbPort) {
        showStatus('Not connected: Missing settings');
    } else {
        let kickConnected = false;
        let sbConnected = false;
        function updateStatus() {
            if (!kickConnected && !sbConnected) {
                showStatus('Not connected');
            } else if (!kickConnected) {
                showStatus('Not connected to Kick');
            } else if (!sbConnected) {
                showStatus('Not connected to Streamer.bot');
            } else {
                hideStatus();
            }
        }
        const KICK_PUSHER_KEY = "32cbd69e4b950bf97679";
        const KICK_PUSHER_CLUSTER = "us2";
        const ACCOUNT = {
            id: 1,
            name: "KickUser",
            chatroomId: chatroomId,
            streamerId: chatroomId,
            channels: {
                chatroomv2: `chatrooms.${chatroomId}.v2`,
                chatroom: `chatroom_${chatroomId}`,
                chatrooms: `chatrooms_${chatroomId}`
            }
        };
        const SB_WEBSOCKET_IP = sbIp;
        const SB_WEBSOCKET_PORT = sbPort;
        const SB_WEBSOCKET_ENDPOINT = "/";
        let sbSocket = null;
        // Get reward prefix from URL (default to 'KickReward-'), ensure it ends with a dash and has no underscores
        let rewardPrefix = getQueryParam('rewardprefix') || 'KickReward-';
        rewardPrefix = rewardPrefix.replace(/_/g, '-');
        if (!rewardPrefix.endsWith('-')) rewardPrefix += '-';
        // Debug: Log Streamer.bot connection state
        function connectStreamerBot() {
            const wsUrl = `ws://${SB_WEBSOCKET_IP}:${SB_WEBSOCKET_PORT}${SB_WEBSOCKET_ENDPOINT}`;
            console.log('[Streamer.bot] Connecting to:', wsUrl);
            try {
                sbSocket = new WebSocket(wsUrl);
                sbSocket.onopen = () => {
                    console.log('[Streamer.bot] Connected');
                    sbConnected = true;
                    updateStatus();
                };
                sbSocket.onerror = (e) => {
                    console.log('[Streamer.bot] Connection error', e);
                    sbConnected = false;
                    updateStatus();
                };
                sbSocket.onclose = (e) => {
                    console.log('[Streamer.bot] Disconnected', e);
                    sbConnected = false;
                    updateStatus();
                    setTimeout(connectStreamerBot, 5000);
                };
            } catch (error) {
                console.log('[Streamer.bot] Failed to create connection', error);
                sbConnected = false;
                updateStatus();
                setTimeout(connectStreamerBot, 5000);
            }
        }
        const pusher = new Pusher(KICK_PUSHER_KEY, {
            cluster: KICK_PUSHER_CLUSTER,
            forceTLS: true
        });
        // Subscribe to all relevant chatroom channels to verify actual chatroom connection
        let chatroomSubs = [];
        let chatroomSuccess = 0;
        let chatroomFail = 0;
        function updateKickConnected() {
            if (chatroomSuccess > 0) {
                kickConnected = true;
            } else {
                kickConnected = false;
            }
            updateStatus();
        }
        // Debug: Log chatroom subscription events
        function bindChatroomSub(channelName) {
            const ch = pusher.subscribe(channelName);
            chatroomSubs.push(ch);
            ch.bind('pusher:subscription_succeeded', () => {
                console.log(`[Kick] Subscribed to ${channelName}`);
                chatroomSuccess++;
                updateKickConnected();
            });
            ch.bind('pusher:subscription_error', () => {
                console.log(`[Kick] Subscription error for ${channelName}`);
                chatroomFail++;
                updateKickConnected();
            });
        }
        bindChatroomSub(ACCOUNT.channels.chatroomv2);
        bindChatroomSub(ACCOUNT.channels.chatroom);
        bindChatroomSub(ACCOUNT.channels.chatrooms);
        // Debug: Log Pusher connection state
        pusher.connection.bind('state_change', (states) => {
            console.log('[Kick] Pusher state change:', states);
            // Still update on general connection state, but rely on chatroom subscription for true status
            if (states.current !== 'connected') {
                kickConnected = false;
                updateStatus();
            }
        });
        pusher.connection.bind('error', (err) => {
            console.log('[Kick] Pusher error:', err);
            kickConnected = false;
            updateStatus();
        });
        updateStatus();
        connectStreamerBot();

        // Debug: Log reward events
        // Reward event handler
        function handleRewardRedemption(data) {
            let rewardData = null;
            if (typeof data === 'string') {
                try {
                    rewardData = JSON.parse(data);
                } catch (e) {
                    console.log('[Kick] Failed to parse reward data', data);
                    return;
                }
            } else if (typeof data === 'object' && data !== null) {
                rewardData = data;
            } else {
                return;
            }
            if (!rewardData || typeof rewardData !== 'object') return;
            let rewardTitle = rewardData.reward_title || '';
            rewardTitle = rewardTitle.trim();
            // Remove leading dashes from rewardTitle to avoid double dash
            rewardTitle = rewardTitle.replace(/^[-]+/, '');
            const username = rewardData.username;
            const userInput = rewardData.user_input;
            console.log('[Kick] Reward redeemed:', rewardData);
            // Prepare args for Streamer.bot
            const args = {
                kickRewardTitle: rewardTitle,
                kickUsername: username,
                kickUserInput: userInput,
                kickUserId: rewardData.user_id,
                kickChannelId: rewardData.channel_id
            };
            // Construct the action name: always <prefix>-<RewardTitle> (single dash)
            const actionName = `${rewardPrefix}${rewardTitle}`;
            // Trigger the specific Streamer.bot action by name
            if (sbSocket && sbSocket.readyState === WebSocket.OPEN) {
                console.log('[Streamer.bot] Sending action:', actionName, args);
                const request = {
                    request: "DoAction",
                    action: { name: actionName },
                    args: args,
                    id: `kick-${Date.now()}`
                };
                sbSocket.send(JSON.stringify(request));
            } else {
                console.log('[Streamer.bot] Not connected (reward not sent)');
                showStatus('Not connected to Streamer.bot (reward not sent)');
            }
        }
        // Subscribe to reward events on all chatroom channels
        function bindRewardEvents(channel) {
            channel.bind('RewardRedeemedEvent', handleRewardRedemption);
        }
        chatroomSubs.forEach(bindRewardEvents);
    }
</script>
</body>
</html>